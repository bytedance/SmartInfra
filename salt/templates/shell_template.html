{% extends "base.html" %}
{% load i18n %}
{% load static %}
{% block content %}
    <div id="content">

    <!-- Begin Page Content -->
    <div class="container-fluid">

        <!-- Page Heading -->
        <h1 class="h3 mb-2 text-gray-800">执行模板</h1>

        <!-- 模态框 -->
        <div class="modal fade" id="shellModal" tabindex="-1" role="dialog" aria-labelledby="shellModalLabel" aria-hidden="true">
          <div class="modal-dialog modal-lg" role="document">
            <div class="modal-content">
              <!-- 模态框头部 -->
              <div class="modal-header">
                <h5 class="modal-title" id="shellModalLabel">执行模板</h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                  <span aria-hidden="true">&times;</span>
                </button>
              </div>
              <!-- 模态框主体内容 -->
              <div class="modal-body">
                <form>
                  <div class="form-group d-flex align-items-center">
                    <label for="input1" class="mr-3 w-25"><span class="text-danger">*</span>&nbsp;名称</label>
                    <input type="text" class="form-control w-75" id="input1" placeholder="请输入内容">
                  </div>
                  <div class="form-group d-flex align-items-center">
                    <label for="input2" class="mr-3 w-25"><span class="text-danger">*</span>&nbsp;描述</label>
                    <input type="text" class="form-control w-75" id="input2" placeholder="请输入内容">
                  </div>

                    <div class="form-group">
                        <label class="mr-3 w-25"><span class="text-danger">*</span>&nbsp;类型&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</label>
                        <div class="form-check form-check-inline">
                            <input class="form-check-input" type="radio" name="exampleRadios" id="radio1" value="option1" checked onchange="switchInput()">
                            <label class="form-check-label" for="radio1">命令</label>
                        </div>
                        <div class="form-check form-check-inline">
                            <input class="form-check-input" type="radio" name="exampleRadios" id="radio2" value="option2" onchange="switchInput()">
                            <label class="form-check-label" for="radio2">state</label>
                        </div>
                    </div>
                    <hr>
                    <div id="file_name_comment_div" class="form-group d-flex align-items-center">
                        <label id="file_name_comment" class="mr-3 w-100" style="display: none;"><span class="text-danger">* 为防止名称重复，所以预生成 salt://{{ state_home }}*.sls&ps1 文件名称。请务必在内容中填写正确</span></label>
                    </div>
                    <div id="editor_shell_div" class="form-group d-flex align-items-center">
                        <label id="editor_shell_label" class="mr-3 w-25"><span class="text-danger">*</span>&nbsp;shell内容</label>
                        <div id="editor_shell" class="w-75" style="height: 400px; border: 1px solid #ccc;"></div>
                    </div>
                    <div id="editor_sls_div" class="form-group d-flex align-items-center" style="display: none;">
                        <label id="editor_sls_label" style="display: none;word-wrap: break-word;" class="mr-3 w-25"><span class="text-danger">*</span>&nbsp;sls内容</label>
                        <div id="editor_sls" class="w-75" style="height: 300px; border: 1px solid #ccc;display: none;"></div>
                    </div>
                    <div id="editor_ps1_div" class="form-group d-flex align-items-center" style="display: none;">
                        <label id="editor_ps1_label" style="display: none;word-wrap: break-word;" class="mr-3 w-25">&nbsp;ps1内容</label>
                        <div id="editor_ps1" class="w-75" style="height: 300px; border: 1px solid #ccc;display: none;"></div>
                    </div>

                  <div style="display: none;">
                    <label for="input6" class="mr-3 w-25"></label>
                    <input type="text" class="form-control w-75" id="input6" placeholder="">
                  </div>
                </form>
                  <label class="mr-3 w-100"><span id="msg" class="text-danger"></span></label>
              </div>
              <!-- 模态框底部 -->
              <div class="modal-footer">
                <button type="button" class="btn btn-primary" onclick="create_shell_template()">提交</button>
              </div>
            </div>
          </div>
        </div>

        <!-- 确认模态框 -->
        <div class="modal fade" id="confirmModal" tabindex="-1" role="dialog" aria-labelledby="confirmModalLabel" aria-hidden="true">
          <div class="modal-dialog" role="document">
            <div class="modal-content">
              <!-- 模态框头部 -->
              <div class="modal-header">
                <h5 class="modal-title" id="confirmModalLabel">确认操作</h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                  <span aria-hidden="true">&times;</span>
                </button>
              </div>
              <!-- 模态框主体内容 -->
              <div class="modal-body">
                您确定要进行此操作吗？该操作无法撤销
              </div>
              <div class="modal-body">
                <label class="mr-3 w-100"><span id="confirm_msg" class="text-danger"></span></label>
              </div>
              <!-- 模态框底部 -->
              <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-dismiss="modal">取消</button>
                <button type="button" class="btn btn-danger" id="confirmButton" onclick="del_shell_template()">确认</button>
              </div>
            </div>
          </div>
        </div>
        <!-- DataTales Example -->
        <div class="card shadow mb-4">
            <div class="card-header py-3">
                <button id="add_salt" class="btn btn-primary btn-sm mr-2" onclick="clear_rowText()"> &nbsp;添&nbsp;加&nbsp; </button>
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-bordered" id="dataTable" width="100%" cellspacing="0">
                        <thead>
                            <tr>
                                <th>名称</th>
                                <th>描述</th>
                                <th>内容类型</th>
                                <th>入口内容</th>
                                <th>执行内容</th>
                                {% if request.user.is_superuser %}
                                    <th>创建人</th>
                                {% endif %}
                                <th>更新时间</th>
                                <th>操作</th>
                            </tr>
                        </thead>
                        <tfoot>
                            <tr>
                                <th>名称</th>
                                <th>描述</th>
                                <th>内容类型</th>
                                <th>入口内容</th>
                                <th>执行内容</th>
                                {% if request.user.is_superuser %}
                                    <th>创建人</th>
                                {% endif %}
                                <th>更新时间</th>
                                <th>操作</th>
                            </tr>
                        </tfoot>
                        <tbody>
                            <tr style="display: none;">
                                <td></td>
                                <td></td>
                                <td></td>
                                <td></td>
                                <td></td>
                                {% if request.user.is_superuser %}
                                    <td></td>
                                {% endif %}
                                <td></td>
                                <td></td>
                            </tr>
                            {% for each_shell in all_shell %}
                            <tr id="tr-{{ each_shell.id }}">
                                <td>{{ each_shell.name }}</td>
                                <td>{{ each_shell.description }}</td>
                                <td>{{ each_shell.get_type_display }}</td>
                                <td style="white-space: pre-wrap;">{{ each_shell.main_content|linebreaksbr }}</td>
                                <td style="white-space: pre-wrap;">{{ each_shell.func_content|linebreaksbr }}</td>
                                {% if request.user.is_superuser %}
                                    <td>{{ each_shell.user.username }}</td>
                                {% endif %}
                                <td>{{ each_shell.update_time }}</td>
                                <td style="display: none;">{{ each_shell.id }}</td>
                                <td>
                                    <button type="button" class="btn btn-primary btn-sm" onclick="get_rowText(this)" data-file-name="{{ each_shell.file_name }}" data-row-id="tr-{{ each_shell.id }}">编辑</button>
                                    <button type="button" class="btn btn-danger btn-sm" onclick="get_rowid(this)" id="{{ each_shell.id }}">删除</button>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

    </div>
    <!-- /.container-fluid -->
    <div id="load" class="position-fixed w-100 h-100"
     style="top: 0; left: 0; background: rgba(255, 255, 255, 0.2); z-index: 1100; display: none;
            justify-content: center;
            align-items: center;">
        <div class="spinner-border text-success" role="status" style="width: 3rem; height: 3rem; position: absolute; top: 50%; left: 50%; margin-top: -1.5rem; margin-left: -1.5rem;">
        <span class="sr-only">加载中...</span>
    </div>
<script src="{% static 'js/ace.js' %}"></script>

{% endblock content %}
{% block js %}
        <script type="text/javascript">
            // 设置加载图片
            function loading() {
                document.getElementById('load').style.display = 'flex';
            };

            // 移除加载图片
            function loading_remove() {
                document.getElementById('load').style.display = 'none';
            };

            // 移除reminder
            function reminder_remove() {
                var reminder_msg = document.getElementById("msg");
                reminder_msg.innerHTML = '';
            };

            // 初始化ace编辑器
            let editor;
            function init_ace() {
                if (!editor) {
                    editor_shell = ace.edit("editor_shell");
                    editor_shell.setTheme("ace/theme/textmate");
                    editor_shell.session.setMode("ace/mode/sh");
                    editor_shell.setOptions({
                        fontSize: "14px",
                        wrap: true,
                    });
                    editor_sls = ace.edit("editor_sls");
                    editor_sls.setTheme("ace/theme/textmate");
                    editor_sls.session.setMode("ace/mode/yaml");
                    editor_sls.setOptions({
                        fontSize: "14px",
                        wrap: true,
                    });
                    editor_ps1 = ace.edit("editor_ps1");
                    editor_ps1.setTheme("ace/theme/textmate");
                    editor_ps1.session.setMode("ace/mode/yaml");
                    editor_ps1.setOptions({
                        fontSize: "14px",
                        wrap: true,
                    });
                }
                editor_shell.resize(); // 重新计算布局
                editor_sls.resize(); // 重新计算布局
                editor_ps1.resize(); // 重新计算布局
            }

            //创建shell template
            function create_shell_template() {
                reminder_remove()
                var reminder_msg = document.getElementById("msg");

                var editor_shell_content = "";
                var editor_sls_content = "";
                var editor_ps1_content = "";
                if (radio1.checked) {
                  editor_shell_content = editor_shell.getValue();
                }
                if (radio2.checked) {
                  editor_sls_content = editor_sls.getValue();
                  editor_ps1_content = editor_ps1.getValue();
                }

                $.ajax({
                    type: "post",
                    url: "/create_shell_template/",
                    dataType: "json",
                    data: {
                        input1: $("#input1").val(),
                        input2: $("#input2").val(),
                        editor_shell_content: editor_shell_content,
                        editor_sls_content: editor_sls_content,
                        editor_ps1_content: editor_ps1_content,
                        input6: $("#input6").val(),
                        file_name: document.querySelector('#file_name_comment').getAttribute('data-value'),
                    },
                    complete: function () {
                    },
                    success: function (data) {
                        if (data.status === 0) {
                            reminder_msg.innerHTML = 'Reminder: ' + data.msg;
                            $('#shellModal').modal('hide');
                            location.reload();
                        } else {
                            reminder_msg.innerHTML = 'Reminder: ' + data.msg;
                        }
                    },
                    error: function (XMLHttpRequest, textStatus, errorThrown) {
                        reminder_msg.innerHTML = 'Reminder: ' + errorThrown;
                    }
                });
            }

            // 点击删除按钮时设置确认按钮的
            function get_rowid(button) {
                    reminder_remove();
                    // 设置确认按钮的 data-id 属性
                    document.querySelector('#confirmButton').setAttribute('data-id', button.id);

                    // 显示确认框
                    $('#confirmModal').modal('show');
            }

            // 编辑按钮时填充内容
            function get_rowText(button) {
                // 清除可能的提示信息
                reminder_remove();
                // 初始化ace编辑器
                init_ace()
                editor_shell.setValue("");
                editor_sls.setValue("");
                editor_ps1.setValue("");
                // 获取当前编辑行的所有列
                const rowId = button.getAttribute('data-row-id');
                const rowFileName = button.getAttribute('data-file-name');
                const row = document.getElementById(rowId);
                const name = row.querySelector('td:nth-child(1)').textContent;
                const description = row.querySelector('td:nth-child(2)').textContent;
                const type = row.querySelector('td:nth-child(3)').textContent;
                const main = row.querySelector('td:nth-child(4)').innerHTML.trim().replace(/<br\s*\/?>/g, '\n');
                const func = row.querySelector('td:nth-child(5)').innerHTML.trim().replace(/<br\s*\/?>/g, '\n');
                const id = row.querySelector('td:nth-child(7)').textContent;
                // 对前两行赋值
                document.querySelector('#input1').value=name;
                document.querySelector('#input2').value=description;
                // 获取所有隐藏的组件id
                const editor_shell1 = document.getElementById("editor_shell");
                const editor_shell_div1 = document.getElementById("editor_shell_div");
                const editor_shell_label1 = document.getElementById("editor_shell_label");
                const editor_sls1 = document.getElementById("editor_sls");
                const editor_sls_div1 = document.getElementById("editor_sls_div");
                const editor_sls_label1 = document.getElementById("editor_sls_label");
                const editor_ps11 = document.getElementById("editor_ps1");
                const editor_ps1_div1 = document.getElementById("editor_ps1_div");
                const editor_ps1_label1 = document.getElementById("editor_ps1_label");
                const file_name_comment1 = document.getElementById("file_name_comment");
                document.querySelector('#file_name_comment').setAttribute('data-value', rowFileName);
                if (type === "shell") {
                    document.getElementById("radio1").checked = true;
                    document.getElementById("radio2").checked = false;
                    // 触发隐藏和显示动作
                    editor_shell1.style.display = "block";
                    editor_shell_div1.style.display = "block";
                    editor_shell_label1.style.display = "block";
                    editor_sls1.style.display = "none";
                    editor_sls_div1.style.display = "none";
                    editor_sls_label1.style.display = "none";
                    editor_ps11.style.display = "none";
                    editor_ps1_div1.style.display = "none";
                    editor_ps1_label1.style.display = "none";
                    file_name_comment1.style.display = "none";
                    editor_shell.setValue(decodeHTML(main));
                    editor_ps1.setValue("");
                } else {
                    document.getElementById("radio1").checked = false;
                    document.getElementById("radio2").checked = true;
                    // 触发隐藏和显示动作
                    editor_shell1.style.display = "none";
                    editor_shell_div1.style.display = "none";
                    editor_shell_label1.style.display = "none";
                    editor_sls1.style.display = "block";
                    editor_sls_div1.style.display = "block";
                    editor_sls_label1.style.display = "block";
                    editor_ps11.style.display = "block";
                    editor_ps1_div1.style.display = "block";
                    editor_ps1_label1.style.display = "block";
                    file_name_comment1.style.display = "block";
                    document.getElementById("editor_ps1_label").innerHTML = rowFileName+'.ps1 内容';
                    document.getElementById("editor_sls_label").innerHTML = '<span style="color: red;">*</span>'+rowFileName+'.sls 内容';
                    editor_sls.setValue(decodeHTML(main));
                    editor_ps1.setValue(decodeHTML(func));
                }
                document.querySelector('#input6').value=id;

                setTimeout(() => {
                    $('#shellModal').modal('show');
                }, 200);
            };

            // 避免特殊字符被转译html
            function decodeHTML(html) {
                var textArea = document.createElement("textarea");
                textArea.innerHTML = html;
                return textArea.value;
            }

            function switchInput() {
                const radio1 = document.getElementById("radio1");
                const radio2 = document.getElementById("radio2");
                const editor_shell = document.getElementById("editor_shell");
                const editor_shell_div = document.getElementById("editor_shell_div");
                const editor_shell_label = document.getElementById("editor_shell_label");
                const editor_sls = document.getElementById("editor_sls");
                const editor_sls_div = document.getElementById("editor_sls_div");
                const editor_sls_label = document.getElementById("editor_sls_label");
                const editor_ps1 = document.getElementById("editor_ps1");
                const editor_ps1_div = document.getElementById("editor_ps1_div");
                const editor_ps1_label = document.getElementById("editor_ps1_label");
                const file_name_comment = document.getElementById("file_name_comment");

                // 如果 radio1 被选中，显示 div；否则隐藏
                if (radio1.checked) {
                    editor_shell.style.display = "block";
                    editor_shell_div.style.display = "block";
                    editor_shell_label.style.display = "block";
                    editor_sls.style.display = "none";
                    editor_sls_div.style.display = "none";
                    editor_sls_label.style.display = "none";
                    editor_ps1.style.display = "none";
                    editor_ps1_div.style.display = "none";
                    editor_ps1_label.style.display = "none";
                    file_name_comment.style.display = "none";
                } else {
                    editor_shell.style.display = "none";
                    editor_shell_div.style.display = "none";
                    editor_shell_label.style.display = "none";
                    editor_sls.style.display = "block";
                    editor_sls_div.style.display = "block";
                    editor_sls_label.style.display = "block";
                    editor_ps1.style.display = "block";
                    editor_ps1_div.style.display = "block";
                    editor_ps1_label.style.display = "block";
                    file_name_comment.style.display = "block";
                    const rowFileName = document.querySelector('#file_name_comment').getAttribute('data-value');
                    document.getElementById("editor_ps1_label").innerHTML = rowFileName+'.ps1 内容';
                    document.getElementById("editor_sls_label").innerHTML = '<span style="color: red;">*</span>'+rowFileName+'.sls 内容';
                }
            }

            // 添加时清空内容
            function clear_rowText() {
                reminder_remove();

                document.querySelector('#input1').value="";
                document.querySelector('#input2').value="";
                document.querySelector('#input6').value="";

                const currentUser = "{{ request.user.username }}"
                const randomDigits = Math.floor(1000000 + Math.random() * 9000000);
                const timestamp = new Date().toISOString().replace(/[-:.TZ]/g, '');
                const fileName = `${currentUser}_${randomDigits}${timestamp}`;
                document.getElementById("editor_ps1_label").innerHTML = fileName+'.ps1 内容';
                document.getElementById("editor_sls_label").innerHTML = '<span style="color: red;">*</span>'+fileName+'.sls 内容';
                document.querySelector('#file_name_comment').setAttribute('data-value', fileName);

                init_ace()

                // 显示确认框
                $('#shellModal').modal('show');
            };

            //删除shell template
            function del_shell_template() {
                reminder_remove()
                var reminder_msg = document.getElementById("confirm_msg");
                $.ajax({
                    type: "post",
                    url: "/del_shell_template/",
                    dataType: "json",
                    data: {
                        st_id: document.querySelector('#confirmButton').getAttribute('data-id'),
                    },
                    complete: function () {
                    },
                    success: function (data) {
                        if (data.status === 0) {
                            reminder_msg.innerHTML = 'Reminder: ' + data.msg;
                            $('#confirmModal').modal('hide');
                            location.reload();
                        } else {

                            reminder_msg.innerHTML = 'Reminder: ' + data.msg;
                        }
                    },
                    error: function (XMLHttpRequest, textStatus, errorThrown) {
                        reminder_msg.innerHTML = 'Reminder: ' + errorThrown;
                    }
                });
            }
        </script>
{% endblock %}